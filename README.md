# @e22m4u/js-localizer

Легковесный сервис локализации для JavaScript, спроектированный для работы
без глобальных состояний и блокирующих операций.

## Особенности

- **Минимум зависимостей**  
  Маленький размер и высокая производительность.
- **Иммутабельность**  
  Методы клонирования (`clone`, `withLocale`, `withHttpRequest`) позволяют
  использовать базовый экземпляр для создания множества изолированных.
- **Гибкая настройка**  
  Полный контроль над процессом определения локали, списком поддерживаемых
  языков, словарями и резервными языками.
- **Автоматическое определение локали**  
  Поддерживает определение из HTTP-заголовков, URL, query-параметров,
  `localStorage`, `navigator`, HTML-тега и переменных окружения.
- **Поддержка плюрализации**  
  Простая обработка множественных чисел для разных языков
  (правила для `one`, `few`, `many`).
- **Универсальность**  
  Работает как в браузере, так и на сервере (Node.js).
- **Интеграция с Service Container**  
  Может быть интегрирован с
  [@e22m4u/js-service](https://www.npmjs.com/package/@e22m4u/js-service)
  для удобного управления зависимостями. Например, для автоматического получения
  объекта `IncomingMessage` на сервере.

## Содержание

- [Установка](#установка)
- [Быстрый старт](#быстрый-старт)
- [Продвинутое использование](#продвинутое-использование)
  - [Плюрализация (обработка множественных чисел)](#плюрализация-обработка-множественных-чисел)
  - [Перевод из объекта (метод `o`)](#перевод-из-объекта-метод-o)
  - [Управление поддерживаемыми локалями](#управление-поддерживаемыми-локалями)
  - [Иммутабельность и клонирование](#иммутабельность-и-клонирование)
  - [Использование на сервере (Node.js)](#использование-на-сервере-nodejs)
- [Автоматическое определение локали](#автоматическое-определение-локали)
- [Дополнительные утилиты](#дополнительные-утилиты)
  - [numWords](#numwords)
- [API: Настройки конструктора](#api-настройки-конструктора)
- [API: Методы экземпляра](#api-методы-экземпляра)
- [Тесты](#тесты)
- [Лицензия](#лицензия)

## Установка

```bash
npm install @e22m4u/js-localizer
```

Модуль поддерживает ESM.

```js
import {Localizer} from '@e22m4u/js-localizer';
```

## Быстрый старт

Создание экземпляра, добавление словарей и выполнение перевода.

```js
import {Localizer} from '@e22m4u/js-localizer';

// 1. Создание экземпляра и добавление словарей
const localizer = new Localizer();

// Можно добавлять словари по одному...
localizer.setDictionary('ru', {
  hello: 'Привет!',
  helloName: 'Привет, %s!',
});

// ...или несколько сразу
localizer.addDictionaries({
  en: {
    hello: 'Hello!',
    helloName: 'Hello, %s!',
  },
  de: {
    hello: 'Hallo!',
  },
});

// 2. Установка текущей локали
localizer.setLocale('ru');

// 3. Выполнение перевода
console.log(localizer.t('hello'));             // > Привет!
console.log(localizer.t('helloName', 'Олег')); // > Привет, Олег!

// Изменение локали
localizer.setLocale('en');
console.log(localizer.t('helloName', 'Oleg')); // > Hello, Oleg!
```

*Примечание: Форматирование строк (`%s`, `%d`) выполняется с помощью библиотеки
[@e22m4u/js-format](https://www.npmjs.com/package/@e22m4u/js-format).*

## Продвинутое использование

### Плюрализация (обработка множественных чисел)

Для обработки форм множественного числа используется объект
с ключами `one`, `few`, `many`.

**Пример для русского языка (3 формы):**

```js
localizer.setDictionary('ru', {
  iHaveApples: {
    one: 'У меня %d яблоко',
    few: 'У меня %d яблока', // для чисел 2, 3, 4 и дробных
    many: 'У меня %d яблок', // для 0, 5, 6...
  },
});

localizer.setLocale('ru');

console.log(localizer.t('iHaveApples', 1)); // > У меня 1 яблоко
console.log(localizer.t('iHaveApples', 3)); // > У меня 3 яблока
console.log(localizer.t('iHaveApples', 5)); // > У меня 5 яблок
```

**Пример для английского языка (2 формы):**

Для языков с двумя формами множественного числа (например, английского)
достаточно указать `one` и `many` (или `few`). Библиотека автоматически
использует вторую форму для всех чисел, кроме `1` и `-1`.

```js
localizer.setDictionary('en', {
  iHaveApples: {
    one: 'I have %d apple',
    many: 'I have %d apples',
  },
});

localizer.setLocale('en');

console.log(localizer.t('iHaveApples', 1));   // > I have 1 apple
console.log(localizer.t('iHaveApples', 0));   // > I have 0 apples
console.log(localizer.t('iHaveApples', 10));  // > I have 10 apples
```

### Перевод из объекта (метод `o`)

Метод `o()` удобен, когда переводы хранятся не в глобальных словарях,
а непосредственно в коде (например, в UI-компоненте).

```js
const localizer = new Localizer();
localizer.setLocale('ru');

const title = {
  en: 'Hello!',
  de: 'Hallo!',
  ru: 'Привет!',
};

console.log(localizer.o(title)); // > Привет!

// Метод также поддерживает плюрализацию
const counter = {
  en: {one: '%d item', many: '%d items'},
  ru: {one: '%d товар', few: '%d товара', many: '%d товаров'},
};

console.log(localizer.o(counter, 5)); // > 5 товаров
```

Если перевод для текущей локали отсутствует, будет использована резервная
локаль (`fallbackLocale`), а если и она недоступна, то будет возвращён
перевод для первого найденного языка в объекте. Если подходящий перевод
так и не будет найден (например, объект пуст), метод вернёт пустую строку.

### Управление поддерживаемыми локалями

Вы можете явно указать список всех поддерживаемых вашим приложением локалей
с помощью опции `supportedLocales`. Это позволяет механизму определения
локали распознавать язык как "валидный", даже если для него ещё не загружен
словарь.

Это полезно в следующих случаях:

- **Для UI-элементов**, таких как переключатель языка. Вы можете получить
  полный список с помощью `getAvailableLocales()` и отобразить все опции.
- **Для ленивой загрузки словарей**. Приложение может определить локаль `es`,
  зная, что она поддерживается, и только после этого подгрузить для неё
  файл с переводами.

```js
const localizer = new Localizer({
  // 'es' поддерживается, но словаря для него пока нет
  supportedLocales: ['en', 'es'],
  fallbackLocale: 'en',
  dictionaries: {
    en: {greeting: 'Hello!'}
  }
});

// Механизм автоматического определения локали (например, из URL ?lang=es)
// примет 'es' как поддерживаемую. Для простоты установим её вручную:
localizer.setLocale('es');

console.log(localizer.getLocale()); // > 'es'

// Так как для 'es' нет словаря, перевод будет взят из fallback-локали 'en'
console.log(localizer.t('greeting')); // > 'Hello!'

// Список доступных локалей будет включать 'es'
console.log(localizer.getAvailableLocales()); // > ['en', 'es']
```

### Иммутабельность и клонирование

`Localizer` спроектирован так, чтобы его состояние было предсказуемым.
Вместо изменения текущего экземпляра вы можете создавать его клоны.
Это особенно полезно в серверной среде, где для каждого запроса нужен
свой изолированный экземпляр.

```js
// Базовый экземпляр со всеми словарями
const baseLocalizer = new Localizer({
  dictionaries: {
    en: {greetings: 'Hello!'},
    ru: {greetings: 'Привет!'},
  },
});

// Клон для русскоговорящего пользователя
const ruLocalizer = baseLocalizer.withLocale('ru');
console.log(ruLocalizer.t('greetings')); // > Привет!

// Клон для англоговорящего пользователя
const enLocalizer = baseLocalizer.withLocale('en');
console.log(enLocalizer.t('greetings')); // > Hello!

// Исходный экземпляр не изменился
console.log(baseLocalizer.getLocale()); // > en (fallback по умолчанию)
```

### Использование на сервере (Node.js)

Метод `withHttpRequest()` предназначен для создания клона `Localizer`,
который будет использовать HTTP-запрос для автоматического определения
языка (например, из заголовка `Accept-Language`).

```js
// Пример для Express.js
// const baseLocalizer = new Localizer({...});

function middleware(req, res, next) {
  // Создание изолированной копии для текущего запроса
  req.localizer = baseLocalizer.withHttpRequest(req);
  next();
}

app.get('/', (req, res) => {
  // req.localizer уже настроен на нужный язык,
  // определенный из заголовков запроса
  const greeting = req.localizer.t('greetings');
  res.send(greeting);
});
```

## Автоматическое определение локали

Если локаль не установлена явно через `setLocale()` или `withLocale()`,
то `Localizer` попытается определить её автоматически при первом
вызове `getLocale()` или `t()`. Механизм определения ищет совпадения
только среди локалей, известных библиотеке
(из `dictionaries` или `supportedLocales`).

Порядок определения задаётся опцией `detectionOrder` и по умолчанию
выглядит так:

```js
[
  'requestHeader', // Заголовок HTTP (Node.js)
  'urlPath',       // Сегмент URL
  'query',         // Query-параметр
  'localStorage',  // Локальное хранилище
  'htmlTag',       // Атрибут <html lang="">
  'navigator',     // Настройки браузера
  'env'            // Переменные окружения (Node.js)
]
```

Ниже подробно описан каждый источник.

#### `requestHeader` (только Node.js)
Локаль определяется из HTTP-заголовка запроса.
По умолчанию используется заголовок `accept-language`.

- **Опция:** `requestHeaderName`  
  (имя заголовка, по умолчанию `'accept-language'`)

#### `urlPath` (только браузер)

Библиотека может извлечь локаль из сегмента пути URL.
По умолчанию используется нулевой сегмент (`/ru/products`).

- **Опция:** `urlPathIndex`  
  (индекс сегмента, по умолчанию `0`)

#### `query` (только браузер)

Локаль может быть передана в параметрах запроса URL.
По умолчанию используется ключ `lang`.

- **Опция:** `queryStringKey`  
  (имя параметра, по умолчанию `'lang'`)

#### `localStorage` (только браузер)

Отличный способ сохранить выбор языка пользователя между сессиями.
По умолчанию используется ключ `language`.

- **Опция:** `localStorageKey`  
  (ключ в хранилище, по умолчанию `'language'`)

#### `htmlTag` (только браузер)

Локаль считывается из атрибута `lang` корневого элемента `<html>`.

#### `navigator` (только браузер)

Модуль использует `navigator.languages[0]`, чтобы определить предпочитаемый
язык пользователя, установленный в его браузере или ОС.

#### `env` (только Node.js)

Этот метод полезен для скриптов, утилит командной строки или серверного
рендеринга (SSR). Проверка переменных окружения выполняется в следующем порядке:

1. `LANG`
2. `LANGUAGE`
3. `LC_MESSAGES`
4. `LC_ALL`

Модуль автоматически извлекает код языка из строк формата `ru_RU.UTF-8`,
оставляя `ru_RU`, и затем подбирая подходящую локаль (`ru`).

## Дополнительные утилиты

Библиотека также экспортирует некоторые полезные функции.

### numWords

Функция для выбора правильной формы слова в зависимости от числа.
Она используется внутри `Localizer`, но может быть полезна и сама по себе.

```js
import {numWords} from '@e22m4u/js-localizer';

// Для русского языка (3 формы: one, few, many)
numWords(1, 'товар', 'товара', 'товаров');  // > 'товар'
numWords(2, 'товар', 'товара', 'товаров');  // > 'товара'
numWords(5, 'товар', 'товара', 'товаров');  // > 'товаров'

// Для английского языка (2 формы: one, few/many)
numWords(1, 'item', 'items'); // > 'item'
numWords(5, 'item', 'items'); // > 'items'
numWords(0, 'item', 'items'); // > 'items'
```

## API: Настройки конструктора

Настройки передаются в конструктор `new Localizer(options)`.

- `supportedLocales: string[]`  
  Явный список поддерживаемых локалей. Позволяет распознавать локаль как
  допустимую, даже если для неё нет словаря. Полезно для динамической загрузки
  переводов.  
  *По умолчанию:* `[]`

- `fallbackLocale: string`  
  Резервная локаль. Используется, если перевод для текущей локали не найден
  или если не удалось определить локаль автоматически.  
  *По умолчанию:* `'en'`

- `dictionaries: LocalizerDictionaries`  
  Объект со словарями, где ключ - это локаль.  
  *По умолчанию:* `{}`

- `detectionOrder: DetectionSource[]`  
  Массив, определяющий порядок источников для автоматического определения
  локали.  
  *По умолчанию:* `['requestHeader', 'urlPath', 'query', 'localStorage', 'htmlTag', 'navigator', 'env']`

- `urlPathIndex: number`  
  Индекс сегмента URL, в котором находится локаль (например, для `/en/users`
  индекс `0`).  
  *По умолчанию:* `0`

- `queryStringKey: string`  
  Имя query-параметра для локали (например, `?lang=en`).  
  *По умолчанию:* `'lang'`

- `localStorageKey: string`  
  Ключ в `localStorage` для хранения локали.  
  *По умолчанию:* `'language'`

- `requestHeaderName: string`  
  Имя HTTP-заголовка для определения локали на сервере.  
  *По умолчанию:* `'accept-language'`

- `httpRequest: IncomingMessage`  
  (Node.js) Объект HTTP-запроса для использования в качестве источника локали.

- `forcedLocale: string`  
  Принудительно установить локаль, игнорируя автоматическое определение.
  Эквивалентно вызову `.setLocale()` после создания.

- `detectedLocale: string`  
  Предустановленное значение для определенной локали. Полезно для избежания
  повторного определения, например при гидратации на клиенте.

## API: Методы экземпляра

#### Управление локалью

- `getLocale(): string`  
  Возвращает текущую локаль. Если она не была установлена, запускает механизм
  автоматического определения.

- `setLocale(locale: string): this`  
  Явно устанавливает текущую локаль. Это значение будет иметь приоритет
  над автоматически определённой локалью.

- `resetLocale(): this`  
  Сбрасывает принудительно установленную локаль, возвращаясь к использованию
  автоматически определённой или резервной.

- `detectLocale(noResetLocale?: boolean): string`  
  Запускает процесс автоматического определения локали и возвращает результат.
  По умолчанию сбрасывает принудительно установленную локаль.

#### Управление словарями

- `setDictionaries(dictionaries: object): this`  
  Полностью **заменяет** все существующие словари новыми.

- `addDictionaries(dictionaries: object): this`  
  **Дополняет** существующие словари, глубоко сливая новые данные со старыми.

- `setDictionary(locale: string, dictionary: object): this`  
  **Заменяет** словарь для одной указанной локали.

- `addDictionary(locale: string, dictionary: object): this`  
  **Дополняет** словарь для одной указанной локали, глубоко сливая данные.

- `getDictionaries(): object`  
  Возвращает глубокую копию всех словарей.

- `getDictionary(locale: string): object`  
  Возвращает глубокую копию словаря для указанной локали.

- `getAvailableLocales(): string[]`  
  Возвращает массив всех доступных локалей, объединяя ключи из `dictionaries`,
  список из `supportedLocales` и принудительно установленную
  локаль (`forcedLocale`).

#### Перевод

- `t(key: string, ...args: unknown[]): string`  
  Возвращает переведённую и отформатированную строку по ключу из словаря.

- `o(obj: object, ...args: unknown[]): string`  
  Извлекает и форматирует перевод из переданного объекта для текущей локали.

#### Клонирование

- `clone(options?: LocalizerOptions): Localizer`  
  Создаёт полную, независимую копию экземпляра с текущим состоянием.
  Можно передать новые опции для переопределения.

- `withLocale(locale: string): Localizer`  
  Создаёт клон с принудительно установленной новой локалью.

- `withHttpRequest(req: IncomingMessage): Localizer`  
  (Node.js) Создаёт клон с привязанным HTTP-запросом для определения локали.

#### Прочее

- `getState(): LocalizerState`  
  Возвращает глубокую копию текущего состояния (настроек) экземпляра.

- `getHttpRequest(): IncomingMessage | undefined`  
  Возвращает объект HTTP-запроса, если он был предоставлен.

## Тесты

```bash
npm test
```

## Лицензия

MIT